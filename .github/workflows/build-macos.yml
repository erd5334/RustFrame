name: Build macOS

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.2.0)'
        required: true
        type: string
      runner:
        description: 'Runner to use'
        required: true
        type: choice
        options:
          - macos-latest
          - macos-14
          - macos-13
          - self-hosted
        default: 'macos-latest'
      create_release:
        description: 'Create GitHub release'
        required: true
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Required permissions for creating releases
permissions:
  contents: write

jobs:
  build-macos:
    name: Build macOS (${{ matrix.arch }})
    runs-on: ${{ github.event.inputs.runner }}
    strategy:
      matrix:
        include:
          - arch: arm64
            target: aarch64-apple-darwin
            display_name: ARM64 (Apple Silicon)
          - arch: x86_64
            target: x86_64-apple-darwin
            display_name: Intel (x86_64)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update version in project files
        run: |
          version="${{ github.event.inputs.version }}"
          echo "Updating version to: $version"
          
          # Update Cargo.toml - only the [package] section version
          # Use awk to find [package] section and update first version line
          awk -v ver="$version" '
          /^\[package\]/ { in_package=1 }
          /^\[/ && !/^\[package\]/ { in_package=0 }
          in_package && /^version = / && !updated { 
              print "version = \"" ver "\""
              updated=1
              next
          }
          { print }
          ' Cargo.toml > Cargo.toml.tmp && mv Cargo.toml.tmp Cargo.toml
          echo "[OK] Updated Cargo.toml"
          
          # Verify the change - simply check if we can find the version line in [package] section
          echo "Verifying Cargo.toml version..."
          found_version=$(awk '/^\[package\]/ { in_pkg=1; next } /^\[/ && in_pkg { exit } in_pkg && /^version = / { gsub(/"/, "", $3); print $3 }' Cargo.toml)
          if [ "$found_version" = "$version" ]; then
              echo "✓ Version verified in Cargo.toml: $version"
          else
              echo "✗ ERROR: Version verification failed!"
              echo "Expected: $version"
              echo "Found: $found_version"
              grep "^version =" Cargo.toml
              exit 1
          fi
          
          # Update package.json
          sed -i.bak "s/\"version\": \"[0-9]*\.[0-9]*\.[0-9]*\"/\"version\": \"$version\"/" ui/package.json
          echo "[OK] Updated package.json"
          
          # Update tauri.conf.json
          sed -i.bak "s/\"version\": \"[0-9]*\.[0-9]*\.[0-9]*\"/\"version\": \"$version\"/" tauri.conf.json
          echo "[OK] Updated tauri.conf.json"
          
          # Remove backup files
          rm -f Cargo.toml.bak ui/package.json.bak tauri.conf.json.bak
          
          echo ""
          echo "[SUCCESS] Version updated to $version in all files"
      
      - name: Commit version changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Cargo.toml ui/package.json tauri.conf.json
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}" || echo "No changes to commit"
          git push || echo "Nothing to push"
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}
      
      - name: Clear build cache to force version update
        run: |
          echo "Clearing build cache to ensure version is updated..."
          if [ -d "target" ]; then
            rm -rf target
            echo "Removed target/ directory"
          fi
          echo "Cache cleared"
      
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          # Include version in cache key to avoid stale version issues
          key: v${{ github.event.inputs.version }}
      
      - name: Install UI dependencies
        working-directory: ./ui
        run: npm ci
      
      - name: Build UI
        working-directory: ./ui
        run: npm run build
      
      - name: Build Rust for ${{ matrix.display_name }}
        run: cargo build --release --target ${{ matrix.target }} --verbose
      
      - name: Create .app bundle
        run: |
          mkdir -p RustFrame.app/Contents/MacOS
          mkdir -p RustFrame.app/Contents/Resources
          
          # Copy binary
          cp target/${{ matrix.target }}/release/rustframe RustFrame.app/Contents/MacOS/rustframe
          chmod +x RustFrame.app/Contents/MacOS/rustframe
          
          # Create Info.plist
          cat > RustFrame.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>rustframe</string>
              <key>CFBundleIdentifier</key>
              <string>com.salihcantekin.rustframe</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>RustFrame</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ github.event.inputs.version }}</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.15</string>
              <key>NSHighResolutionCapable</key>
              <true/>
              <key>NSSupportsAutomaticGraphicsSwitching</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # Ad-hoc code signing (for local use, not App Store)
          codesign --force --deep --sign - RustFrame.app
          
          echo "✅ .app bundle created and signed"
      
      - name: Create distribution folder
        run: |
          mkdir -p dist
          cp -r RustFrame.app dist/
          cp README.md dist/
          cp LICENSE dist/
      
      - name: Create ZIP archive
        run: |
          cd dist
          timestamp=$(date +%Y%m%d-%H%M%S)
          zipname="RustFrame-macOS-${{ matrix.arch }}-v${{ github.event.inputs.version }}-${timestamp}.zip"
          zip -r "../${zipname}" *
          cd ..
          echo "Created: ${zipname}"
          echo "ZIP_NAME=${zipname}" >> $GITHUB_ENV
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustFrame-macOS-${{ matrix.arch }}-v${{ github.event.inputs.version }}-${{ github.run_number }}
          path: ${{ env.ZIP_NAME }}
          retention-days: 30
      
      - name: Build summary
        run: |
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: macOS" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: ${{ matrix.display_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runner**: ${{ github.event.inputs.runner }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Rust Version**: $(rustc --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: ${{ env.ZIP_NAME }}" >> $GITHUB_STEP_SUMMARY
      
      - name: Create Git tag
        if: github.event.inputs.create_release == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "v${{ github.event.inputs.version }}" -m "Release v${{ github.event.inputs.version }}"
          git push origin "v${{ github.event.inputs.version }}" || echo "Tag already exists"
      
      - name: Create or Update GitHub Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: RustFrame v${{ github.event.inputs.version }}
          body: |
            # RustFrame v${{ github.event.inputs.version }}
            
            ## macOS Build - ${{ matrix.display_name }}
            
            Built with:
            - Architecture: ${{ matrix.display_name }}
            - Target: ${{ matrix.target }}
            - Runner: ${{ github.event.inputs.runner }}
            - Rust: $(rustc --version)
            - Build #${{ github.run_number }}
            
            ### Installation
            1. Download the appropriate version:
               - **Apple Silicon (M1/M2/M3)**: `RustFrame-macOS-arm64-*.zip`
               - **Intel**: `RustFrame-macOS-x86_64-*.zip`
            2. Extract the archive
            3. Drag `RustFrame.app` to Applications folder
            4. Right-click and select "Open" on first launch
            5. Grant Screen Recording permission when prompted
            
            ### Notes
            - Choose the correct architecture for your Mac
            - ARM64 for Apple Silicon Macs (M1, M2, M3, etc.)
            - x86_64 for Intel Macs
            - See [Documentation](https://github.com/salihcantekin/RustFrameApp/tree/main/docs) for detailed instructions
          files: ${{ env.ZIP_NAME }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
