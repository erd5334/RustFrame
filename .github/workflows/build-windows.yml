name: Build Windows

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.2.0)'
        required: true
        type: string
      create_release:
        description: 'Create GitHub release'
        required: true
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# Required permissions for creating releases
permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows (GitHub Hosted)
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Update version in project files
        run: |
          $versionRaw = "${{ github.event.inputs.version }}"
          $version = $versionRaw
          if ($version.StartsWith("v")) { $version = $version.Substring(1) }
          $version = $version -replace '(?i)-(windows|macos)$', ''
          Write-Host "Updating project version to: $version (input: $versionRaw)"
          
          # Update Cargo.toml - update the first version = line after [package]
          $cargoLines = Get-Content Cargo.toml
          $inPackageSection = $false
          $versionUpdated = $false
          
          for ($i = 0; $i -lt $cargoLines.Count; $i++) {
              if ($cargoLines[$i] -match '^\[package\]') {
                  $inPackageSection = $true
                  Write-Host "Found [package] section at line $($i+1)"
              }
              elseif ($cargoLines[$i] -match '^\[') {
                  $inPackageSection = $false
              }
              elseif ($inPackageSection -and $cargoLines[$i] -match '^version\s*=\s*"[^"]*"' -and -not $versionUpdated) {
                  Write-Host "Found version line at line $($i+1): $($cargoLines[$i])"
                  $cargoLines[$i] = "version = `"$version`""
                  Write-Host "Updated to: $($cargoLines[$i])"
                  $versionUpdated = $true
              }
          }
          
          $cargoLines | Set-Content Cargo.toml
          Write-Host "[OK] Updated Cargo.toml"
          
          # Verify the change
          Write-Host "Verifying Cargo.toml version..."
          $verifyContent = Get-Content Cargo.toml -Raw
          if ($verifyContent -match '(?m)^\[package\][\s\S]*?^version\s*=\s*"([^"]*)"') {
              $foundVersion = $matches[1]
              Write-Host "Found version in Cargo.toml: $foundVersion"
              if ($foundVersion -ne $version) {
                  Write-Host "✗ ERROR: Version not found in Cargo.toml!"
                  Write-Host "version = `"$foundVersion`""
                  exit 1
              }
          } else {
              Write-Host "✗ ERROR: Could not find version in [package] section!"
              exit 1
          }
          
          # Update tauri.conf.json
          $tauriContent = Get-Content tauri.conf.json -Raw
          $tauriContent = $tauriContent -replace '"version":\s*"[^"]*"', "`"version`": `"$version`""
          $tauriContent | Set-Content tauri.conf.json -NoNewline
          Write-Host "[OK] Updated tauri.conf.json"
          
          Write-Host ""
          Write-Host "[SUCCESS] Version updated to $version in Cargo.toml and tauri.conf.json"
        shell: powershell
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Clear Cargo cache to force version update
        run: |
          Write-Host "Clearing build cache to ensure version is updated..."
          if (Test-Path target) {
            Remove-Item -Recurse -Force target
            Write-Host "Removed target/ directory"
          }
          Write-Host "Cache cleared"
        shell: powershell
      
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          # Include version in cache key to avoid stale version issues
          key: v${{ github.event.inputs.version }}
      
      - name: Install UI dependencies
        working-directory: ./ui
        run: npm ci
      
      - name: Build UI
        working-directory: ./ui
        run: npm run build
      
      - name: Build Rust (Release)
        run: cargo build --release --verbose
      
      - name: Run tests
        run: cargo test --release --verbose
      
      - name: Create distribution folder
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item target/release/rustframe.exe dist/
          Copy-Item README.md dist/
          Copy-Item LICENSE dist/
        shell: powershell
      
      - name: Create ZIP archive
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
          $zipName = "RustFrame-Windows-x64-$timestamp.zip"
          Compress-Archive -Path dist/* -DestinationPath $zipName
          Write-Host "Created: $zipName"
        shell: powershell
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustFrame-Windows-x64-${{ github.run_number }}
          path: RustFrame-Windows-x64-*.zip
          retention-days: 30
      
      - name: Build summary
        run: |
          echo "## Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platform**: Windows x64 (GitHub Hosted)" >> $GITHUB_STEP_SUMMARY
          echo "- **Rust Version**: $(rustc --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        shell: bash
      
      - name: Get Rust version
        id: rust-version
        run: echo "version=$(rustc --version)" >> $GITHUB_OUTPUT
        shell: bash
      
      - name: Create Git tag
        if: github.event.inputs.create_release == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git tag -a "v${{ github.event.inputs.version }}" -m "Release v${{ github.event.inputs.version }}"
          git push origin "v${{ github.event.inputs.version }}" || echo "Tag already exists or push failed"
        shell: bash
      
      - name: Create or Update GitHub Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: RustFrame v${{ github.event.inputs.version }}
          body: |
            # RustFrame v${{ github.event.inputs.version }}
            
            ## Windows Build
            
            Built with:
            - Runner: windows-latest (GitHub Hosted)
            - Rust: ${{ steps.rust-version.outputs.version }}
            - Build #${{ github.run_number }}
            
            ### Installation
            1. Download `RustFrame-Windows-x64-*.zip`
            2. Extract the archive
            3. Run `rustframe.exe`
            
            ### Notes
            - First run may require Windows Defender approval
            - See [Documentation](https://github.com/salihcantekin/RustFrameApp/tree/main/docs) for detailed instructions
          files: RustFrame-Windows-x64-*.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
