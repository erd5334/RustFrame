name: Build Self-Hosted Windows

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: Build Self-Hosted Windows
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json
      
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
      
      - name: Install UI dependencies
        working-directory: ./ui
        run: npm ci
      
      - name: Build UI
        working-directory: ./ui
        run: npm run build
      
      - name: Build Rust (Release)
        run: cargo build --release --verbose
      
      - name: Run tests
        run: cargo test --release --verbose
      
      - name: Create distribution folder
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item target/release/rustframe.exe dist/
          Copy-Item README.md dist/
          Copy-Item LICENSE dist/
        shell: powershell
      
      - name: Create ZIP archive
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
          $zipName = "RustFrame-Windows-x64-$timestamp.zip"
          Compress-Archive -Path dist/* -DestinationPath $zipName
          Write-Host "Created: $zipName"
        shell: powershell
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: RustFrame-Windows-x64-${{ github.run_number }}
          path: RustFrame-Windows-x64-*.zip
          retention-days: 30
      
      - name: Build summary
        run: |
          Write-Host "## Build Information" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "- **Platform**: Windows x64 (Self-Hosted)" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "- **Rust Version**: $(rustc --version)" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "- **Build Number**: ${{ github.run_number }}" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "- **Commit**: ${{ github.sha }}" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "" | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
          Write-Host "Note: For version management and releases, use the GitHub-hosted workflow." | Out-File -Append -FilePath $env:GITHUB_STEP_SUMMARY
        shell: powershell
